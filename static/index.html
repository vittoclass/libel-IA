Tienes toda la raz√≥n. Te pido disculpas. En mi af√°n por a√±adir capacidades, reintroduje el problema de la complejidad y los botones. El objetivo es que la herramienta trabaje para ti, no que t√∫ trabajes para la herramienta.

He simplificado radicalmente la interfaz y he hecho a la IA m√°s aut√≥noma, bas√°ndome en una nueva filosof√≠a: **Cero Botones Innecesarios.**

### La Soluci√≥n: Una IA Proactiva y Aut√≥noma

He eliminado por completo el bot√≥n del **"‚ú® Asistente IA de R√∫brica"**. Ya no lo necesitas. La IA ahora es proactiva e inteligente:

  * **Si t√∫ proporcionas una r√∫brica:** La IA la usar√°, la respetar√° y la aplicar√° con el juicio profesional que hemos desarrollado.
  * **Si dejas el campo de la r√∫brica EN BLANCO:** La IA lo detectar√° autom√°ticamente. Su primera tarea ser√° analizar la obra del estudiante, **crear una r√∫brica experta y apropiada desde cero**, y luego usar esa misma r√∫brica para realizar la evaluaci√≥n completa. Todo con un solo clic en "Iniciar Evaluaci√≥n".

Esto fusiona la capacidad de la IA para crear y evaluar, reduciendo tu trabajo a lo esencial: subir los trabajos y, solo si lo deseas, proporcionar una pauta. El avanzado "cerebro" metacognitivo que construimos sigue intacto, pero ahora est√° al servicio de un flujo de trabajo mucho m√°s limpio y directo.

Este es el c√≥digo final, con la interfaz simplificada.

```html
<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Genius Evaluator X - Versi√≥n Definitiva</title>
<style>
        :root { --primary: #5e72e4; --secondary: #f4f5f7; --success: #2dce89; --danger: #f5365c; --warning: #fb6340; --info: #11cdef; --bg-light: #f6f9fc; --white: #fff; --radius: 12px; --font-main: 'Open Sans', sans-serif; --text: #525f7f; --shadow: 0 4px 6px rgba(50,50,93,.11), 0 1px 3px rgba(0,0,0,.08); }
        @import url('https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600;700&display=swap');
        body { font-family: var(--font-main); background: var(--bg-light); padding: 2rem; max-width: 900px; margin: auto; color: var(--text); }
        h1, h2, h3, h4 { color: #32325d; font-weight: 700; }
        h1 { font-size: 2.2rem; text-align: center; }
        h2 { font-size: 1.5rem; border-bottom: 2px solid var(--info); padding-bottom: 0.5rem; margin-top: 2rem; }
        h3 { font-size: 1.25rem; margin-top: 1.5rem; padding-bottom: 0.25rem; border-bottom: 1px solid #e9ecef;}
        h4 { font-size: 1.1rem; }
        p { color: #8898aa; line-height: 1.6; }
        .section { background: var(--white); padding: 2rem; border-radius: var(--radius); box-shadow: var(--shadow); margin-bottom: 2rem; }
        details { background: #fdfdff; border: 1px solid #e9ecef; border-radius: var(--radius); padding: 1rem; margin-bottom: 1rem;}
        details summary { font-weight: 600; cursor: pointer; color: var(--primary); }
        button { background-color: var(--primary); color: white; border: none; padding: 0.8rem 1.5rem; font-size: 1rem; font-weight: 600; border-radius: 50px; cursor: pointer; transition: all 0.2s; }
        button:hover { transform: translateY(-2px); box-shadow: 0 7px 14px rgba(50,50,93,.1), 0 3px 6px rgba(0,0,0,.08); }
        button:disabled { background-color: #cad1d7; cursor: not-allowed; transform: none; box-shadow: none; }
        .secondary { background-color: var(--success); }
        .danger-btn { background-color: var(--danger); }
        .action-btn { padding: 0.4rem 0.8rem; font-size: 0.8rem; margin: 0 0.25rem; }
        input, textarea, select { width: 100%; padding: 0.75rem; margin-top: 0.5rem; margin-bottom: 1rem; border: 1px solid #dee2e6; border-radius: var(--radius); box-sizing: border-box; font-family: inherit; font-size: 1rem; }
        input[type="checkbox"] { width: auto; margin-right: 0.5rem; }
        textarea:disabled { background-color: #f8f9fa; cursor: not-allowed; }
        .main-nav { display: flex; justify-content: center; gap: 1rem; margin-bottom: 2rem; }
        .main-tab { background-color: #e9ecef; color: var(--text); }
        .main-tab.active { background-color: var(--primary); color: white; }
        .drop-zone { border: 2px dashed #dee2e6; padding: 2rem; text-align: center; cursor: pointer; transition: all 0.2s; background: var(--secondary); border-radius: var(--radius); }
        .preview-container { display: flex; flex-wrap: wrap; gap: 1rem; margin-top: 1rem; padding: 1rem; background: #f0f2f5; border-radius: var(--radius); min-height: 50px; }
        .preview-item { border: 2px solid #ddd; border-radius: var(--radius); overflow: hidden; width: 150px; position: relative; background: white; text-align: center; font-size: 0.8rem; cursor: pointer; transition: all 0.2s; }
        .preview-item:hover { transform: scale(1.05); }
        .preview-item.selected { border-color: var(--primary); box-shadow: 0 0 12px rgba(94, 114, 228, 0.5); }
        .preview-item img { width: 100%; height: 120px; object-fit: cover; }
        .grouped-item-container { border: 2px solid var(--success); background-color: #f0fff8; padding: 1rem; border-radius: var(--radius); margin-bottom: 1rem; }
        .grouped-item-container h4 { margin-top: 0; font-size: 1rem; color: #1a5c3a; }
        .grouped-item-previews { display: flex; flex-wrap: wrap; gap: 0.5rem; }
        .tarjeta-feedback-wrapper { margin-top: 1.5rem; }
        .tarjeta-feedback { border: 1px solid #e9ecef; box-shadow: var(--shadow); border-radius: var(--radius); overflow: hidden; }
        .tarjeta-feedback-header { padding: 1.5rem; background: #f8f9fa; }
        .tarjeta-feedback-body { padding: 0 1.5rem 1.5rem 1.5rem; }
        .error-box { background-color: #fdd; border: 1px solid var(--danger); color: #58151c; padding: 1rem; border-radius: var(--radius); margin-top: 1rem; white-space: pre-wrap; }
        .cors-warning { display: none; background-color: #fff3cd; border-color: #ffeeba; color: #664d03; padding: 1rem; border-radius: .25rem; text-align: center; margin-bottom: 2rem;}
        #historial-table { width: 100%; border-collapse: collapse; margin-top: 1rem; table-layout: fixed; }
        #historial-table th, #historial-table td { padding: 0.75rem; text-align: left; border-bottom: 1px solid #dee2e6; word-wrap: break-word; vertical-align: middle; }
        #historial-table th { cursor: pointer; user-select: none; }
        #historial-table th:hover { background-color: #f4f5f7; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4); }
        .modal-content { background-color: #fefefe; margin: 5% auto; padding: 20px; border: 1px solid #888; width: 90%; max-width: 700px; border-radius: var(--radius); animation: fadeIn 0.3s; }
        @keyframes fadeIn { from {opacity: 0; transform: scale(0.95);} to {opacity: 1; transform: scale(1);} }
        .close-btn { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
        [contenteditable="true"]:focus, input[type="text"]:focus, input[type="number"]:focus { outline: 2px solid var(--primary); background-color: #e9f2ff; }
        .config-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; align-items: center; }
        .config-grid-full { grid-column: 1 / -1; }
        .config-grid label { margin: 0; }
        .test-btn { width: 120px; flex-shrink: 0; }
        .test-btn.testing { background-color: var(--warning); }
        .test-btn.success { background-color: var(--success); }
        .test-btn.error { background-color: var(--danger); }
        .feedback-tabs { display: flex; border-bottom: 1px solid #dee2e6; margin-bottom: 1.5rem; }
        .tab { padding: 0.75rem 1.25rem; cursor: pointer; background: none; border: none; font-size: 1rem; font-weight: 600; color: #8898aa; border-bottom: 3px solid transparent; margin-bottom: -1px; }
        .tab.active { color: var(--primary); border-bottom-color: var(--primary); }
        .feedback-content { display: none; padding: 1rem 0; } .feedback-content.active { display: block; }
        .nota-container { display:flex; align-items:center; gap: 0.5rem; }
        .add-decimas-btn { padding: 0.2rem 0.6rem; font-size: 1rem; border-radius: 50%; line-height: 1; }
        .analisis-table { width: 100%; border-collapse: collapse; margin-top: 1rem; font-size: 0.9rem; }
        .analisis-table th, .analisis-table td { border: 1px solid #dee2e6; padding: 0.75rem; text-align: left; }
        .analisis-table th { background-color: #f8f9fa; }
        #video-feed { width: 100%; max-height: 400px; border-radius: var(--radius); background-color: #000; }
        blockquote { border-left: 3px solid var(--info); padding-left: 1rem; margin-left: 0; font-style: italic; color: #525f7f; }
        .analisis-profesor { background: #e9f2ff; border: 1px solid var(--primary); padding: 1.5rem; border-radius: var(--radius); margin-bottom: 2rem;}
        #logo-preview { max-width: 100px; max-height: 50px; margin-top: 0.5rem; }
        .flex-container {display: flex; justify-content: space-between; align-items: center; margin-top: 0.5rem;}
        .flex-container span {font-size: 0.9rem; color: #8898aa;}
        .results-actions { padding: 1.5rem; text-align: center; border-top: 1px solid #e9ecef; margin-top: 2rem; background: #fdfdff;}
        #report-content { white-space: pre-wrap; font-family: monospace; background: #f8f9fa; padding: 1rem; border-radius: var(--radius); max-height: 400px; overflow-y: auto; user-select: all; }
    </style>
</head>
<body>
<h1>‚ú® Genius Evaluator X</h1>
<div id="app-container"></div>
<div class="cors-warning" id="cors-warning-container">
<strong>Posible problema de CORS:</strong> Si las pruebas de API fallan con un error de red, intenta servir esta p√°gina desde un servidor local (ej. con la extensi√≥n "Live Server" de VS Code) en lugar de abrir el archivo directamente.
    </div>
<div id="templates" style="display: none;">
<template id="template-main-app">
<div class="main-nav">
<button class="main-tab active" data-action="switch-main-view" data-view="evaluacion">üöÄ Evaluar</button>
<button class="main-tab" data-action="switch-main-view" data-view="historial">üìö Historial</button>
<button class="main-tab" data-action="switch-main-view" data-view="analisis">üìä An√°lisis</button>
</div>
<div id="view-evaluacion">
<div class="section">
<h2>1. Elige tu Flujo de Trabajo</h2>
<p>Selecciona c√≥mo quieres evaluar hoy.</p>
<div style="display: flex; gap: 1rem; justify-content: center; margin-top: 1rem;">
<button class="secondary" data-action="show-workflow" data-workflow="workflow-escaneado">üì∑ Calificar Documentos</button>
</div>
</div>
<div id="workflows-container"></div>
<div id="resultados" style="display: none;"></div>
</div>
<div id="view-historial" style="display: none;"></div>
<div id="view-analisis" style="display: none;"></div>
<div class="modal" id="report-modal"><div class="modal-content"><span class="close-btn" data-action="close-modal" data-target="report-modal">√ó</span><h2>Informe del Estudiante</h2><p style="font-size:0.9rem;">Puedes copiar este texto y pegarlo en cualquier documento. Si el bot√≥n de abajo falla, selecciona el texto y c√≥pialo manualmente (Ctrl+C).</p><div id="report-content" tabindex="0"></div><div style="text-align:center; margin-top: 1rem;"><button class="secondary" data-action="copy-report">Copiar Informe al Portapapeles</button></div></div></div>
<div class="modal" id="decimas-modal"><div class="modal-content"><span class="close-btn" data-action="close-modal" data-target="decimas-modal">√ó</span><h2>Ajuste Manual de Nota</h2><label for="decimas-input">Bonificaci√≥n (ej: 0.5):</label><input id="decimas-input" placeholder="0.0" step="0.1" type="number"/><label for="decimas-justificacion">Justificaci√≥n:</label><textarea id="decimas-justificacion" placeholder="Ej: Por excelente participaci√≥n" rows="3"></textarea><button data-action="save-decimas">Guardar Ajuste</button></div></div>
<div class="modal" id="camera-modal"><div class="modal-content"><span class="close-btn" data-action="close-camera-modal">√ó</span><h2>Capturar Imagen</h2><video autoplay="" id="video-feed"></video><canvas id="photo-canvas" style="display:none;"></canvas><div style="text-align:center; margin-top: 1rem;"><button data-action="capture-photo">Capturar Foto</button></div></div></div>
</template>

<template id="template-historial-view">
<div class="section">
<h2>üìö Historial de Evaluaciones</h2>
<p>Aqu√≠ puedes buscar, revisar y exportar todas las evaluaciones guardadas.</p>
<div style="display: flex; justify-content: space-between; align-items: center; gap: 1rem;">
<input id="search-historial" placeholder="Buscar por estudiante, curso o prueba..." style="flex-grow: 1;" type="text"/>
<button class="secondary" data-action="export-grades-csv">Exportar Calificaciones (Libro)</button>
</div>
<table id="historial-table">
<thead><tr>
    <th data-action="sort-history" data-sort="curso" style="width: 20%;">Curso</th>
    <th data-action="sort-history" data-sort="nombreEstudiante" style="width: 25%;">Estudiante</th>
    <th data-action="sort-history" data-sort="nombrePrueba" style="width: 25%;">Evaluaci√≥n</th>
    <th data-action="sort-history" data-sort="notaFinal" style="width: 10%;">Nota</th>
    <th style="width: 20%;">Acciones</th>
</tr></thead>
<tbody id="historial-tbody"></tbody>
</table>
<div style="margin-top: 2rem;"><button class="danger-btn" data-action="clear-history">Limpiar Historial</button></div>
</div>
</template>

<template id="template-analisis-view">
<div class="section">
    <h2>üìä M√≥dulo de An√°lisis de Datos</h2>
    <p>Visualiza el rendimiento acad√©mico a trav√©s de gr√°ficos interactivos.</p>
    <div style="margin-top:2rem;">
        <h3>Comparativa de Habilidades entre Cursos</h3>
        <p>Compara el dominio de habilidades clave entre dos cursos que realizaron la misma evaluaci√≥n.</p>
        <div class="config-grid">
            <select id="compare-course1"></select>
            <select id="compare-course2"></select>
        </div>
        <div class="config-grid-full">
            <label for="compare-test">Seleccionar Evaluaci√≥n en Com√∫n:</label>
            <select id="compare-test"></select>
        </div>
        <canvas id="skill-comparison-chart" style="margin-top: 1rem;"></canvas>
    </div>
    <div style="margin-top:2rem;">
        <h3>Seguimiento del Progreso Individual (Portafolio Digital)</h3>
        <p>Selecciona un estudiante para ver la evoluci√≥n de sus calificaciones y habilidades.</p>
        <label for="student-progress-select">Seleccionar Estudiante:</label>
        <select id="student-progress-select"></select>
        <canvas id="student-progress-chart" style="margin-top: 1rem;"></canvas>
        <div id="student-skills-table-container" style="margin-top: 2rem;"></div>
    </div>
</div>
</template>

<template id="template-configuracion-evaluacion">
<details open="">
<summary>‚öôÔ∏è 2. Configuraci√≥n de Evaluaci√≥n</summary>
<div class="config-grid" style="margin-top: 1rem;">
    <div><label for="nivel-exigencia">Nivel de Exigencia (%):</label><input id="nivel-exigencia" max="100" min="1" type="number" value="60"/></div>
    <div><label for="nota-aprobacion">Nota de Aprobaci√≥n:</label><input id="nota-aprobacion" max="7.0" step="0.1" type="number" value="4.0"/></div>
    <div><label for="puntaje-maximo">Puntaje M√°ximo Total:</label><input id="puntaje-maximo" min="1" type="number" value="30"/></div>
    <div><label for="sistema-calificacion">Sistema de Calificaci√≥n:</label><select id="sistema-calificacion"><option value="chile_2_7">Chile (2.0 - 7.0)</option></select></div>
</div>
<div class="config-grid-full" style="margin-top: 1rem; border-top: 1px solid #e9ecef; padding-top: 1rem;">
    <div style="display: flex; align-items: center; gap: 1rem;">
        <label for="activar-nota-minima" style="flex-shrink: 0; margin-bottom: 0;">
            <input type="checkbox" id="activar-nota-minima" onchange="document.getElementById('nota-minima-input').disabled = !this.checked;">
            <strong>Activar Nota M√≠nima:</strong>
        </label>
        <input type="number" id="nota-minima-input" step="0.1" value="2.0" disabled style="margin: 0;">
    </div>
    <p style="font-size: 0.85rem; margin-top: 0.5rem;">Si se activa, el sistema se asegurar√° de que la nota no sea inferior a este valor para reconocer el esfuerzo.</p>
</div>
</details>
</template>

<template id="template-workflow-escaneado">
<div id="config-container-escaneado"></div>
<div class="section">
<h2>üì∑ 3. Datos Generales de la Evaluaci√≥n</h2>
<div class="config-grid">
<div><label for="nombre-prueba-escaneada"><strong>Nombre de la Evaluaci√≥n:</strong></label><input id="nombre-prueba-escaneada" placeholder="Ej: Ensayo Final / Gu√≠a de Artes" type="text"/></div>
<div><label for="curso-escaneado"><strong>Curso:</strong></label><input id="curso-escaneado" placeholder="Ej: 8vo B / 3ro Medio C - PIE" type="text"/></div>
</div>
<div class="config-grid">
<div><label for="department-input"><strong>Departamento (Opcional):</strong></label><input id="department-input" placeholder="Ej: Departamento de Artes" type="text"/></div>
<div><label for="test-date-input"><strong>Fecha de Evaluaci√≥n (Opcional):</strong></label><input id="test-date-input" type="date"/></div>
</div>
<div>
<label for="school-logo-input" style="display:block; margin-top: 1rem;"><strong>Logo del Colegio (Opcional):</strong></label>
<input accept="image/png, image/jpeg" id="school-logo-input" style="padding:0; border:none;" type="file"/>
<img alt="Vista previa del logo" id="logo-preview" src="" style="display:none;"/>
</div>
</div>
<div class="section">
<h3>4. Cargar y Agrupar Documentos de Estudiantes</h3>
<p>Arrastra los archivos o usa la c√°mara. Luego, <strong>haz clic en las im√°genes para seleccionarlas y agr√∫palas por estudiante</strong> si es necesario (ej. una foto para el nombre y otra para la obra).</p>
<div style="display:flex; gap: 1rem; align-items: center; margin-bottom: 1rem;">
<button class="secondary" data-action="open-camera-modal">üì∑ Usar C√°mara</button>
</div>
<div class="drop-zone" id="dropZoneEscaneado">üñºÔ∏è Arrastra las im√°genes, PDFs o DOCX aqu√≠</div>
<input accept="image/*,.pdf,.doc,.docx,application/msword,application/vnd.openxmlformats-officedocument.wordprocessingml.document" id="archivosEscaneados" multiple="" style="display: none;" type="file"/>

<div id="grouping-controls" style="display: none; margin-top: 1.5rem; text-align: center;">
    <button class="secondary" data-action="create-manual-group">‚ûï Agrupar Selecci√≥n</button>
</div>
<div id="grouped-preview-container" style="margin-top: 1rem;"></div>
<div class="preview-container" id="previewContainerEscaneado" style="margin-top: 1rem;"></div>
</div>
<div class="section">
<h3>5. Definir Pauta de Evaluaci√≥n (R√∫brica)</h3>
<p style="font-size:0.9rem;"><strong>Deja este campo en blanco y la IA crear√° una r√∫brica por ti.</strong> O pega tu propia pauta para guiarla.</p>
<label class="button secondary" for="archivoRubrica" style="display: block; margin-top: 1rem; cursor:pointer;">Cargar R√∫brica de Desarrollo (.txt, .docx, .pdf)</label>
<input accept=".txt,.docx,.pdf" id="archivoRubrica" style="display:none;" type="file"/>
<label for="instruccionesEscaneado" style="margin-top:1rem;">O pega la pauta/r√∫brica:</label>
<textarea id="instruccionesEscaneado" placeholder="Ej: Criterio 1: Identifica 3 causas (6 Puntos). Criterio 2: Argumentaci√≥n clara (4 Puntos)..." rows="6"></textarea>
<hr style="margin: 1.5rem 0;"/>
<label for="preguntasObjetivas">Preguntas Objetivas (Opcional):</label>
<textarea id="preguntasObjetivas" placeholder="Ej:\nPregunta 1 (V/F): La respuesta correcta es Verdadero. (2 Puntos)\nPregunta 2 (Alternativas): La respuesta correcta es C. (2 Puntos)" rows="4"></textarea>
</div>
<div class="section" id="revision-container">
<h3>6. Revisi√≥n y Preparaci√≥n</h3>
<p>Aqu√≠ aparecer√° el texto extra√≠do de cada grupo para tu revisi√≥n final antes de evaluar.</p>
</div>
<div class="section">
<h3>7. Iniciar Evaluaci√≥n</h3>
<button id="evaluate-button" data-action="evaluate-scanned">üöÄ Iniciar Evaluaci√≥n de Lote</button>
</div>
</template>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/mammoth@1.4.8/mammoth.browser.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // --- ESTADO Y CONFIGURACI√ìN ---
    const appState = {
        MISTRAL_KEY: "", AZURE_KEY: "", AZURE_ENDPOINT: "",
        mistralReady: false, azureReady: false,
        historial: [],
        loteEscaneado: { 
            files: [],
            groups: [],
            studentData: [], 
            lastBatchIds: [] 
        },
        sortState: { key: 'curso', asc: true },
        cameraStream: null,
        nameCorrections: {},
        schoolLogoBase64: null,
        charts: { courseChart: null, studentChart: null, skillChart: null },
    };
    
    // --- PROMPTS PARA EL SISTEMA DE DOBLE ESPECIALISTA ---

    const PROMPT_GENERADOR_DE_RUBRICA = `Eres un experto en pedagog√≠a y dise√±o curricular. Analiza el trabajo de un estudiante que se te proporcionar√°. Tu tarea es crear una r√∫brica de evaluaci√≥n justa, completa y bien estructurada, apropiada para el tipo de trabajo y el nivel educativo aparente. La r√∫brica debe tener criterios claros, con descripciones para 4 niveles de desempe√±o (Ej: Excelente, Bueno, Satisfactorio, En Desarrollo) y un puntaje sugerido para cada criterio. Devuelve √∫nicamente el texto de la r√∫brica, nada m√°s.`;

    const SISTEMA_OPERATIVO_EVALUADOR_EXPERTO = `
### SISTEMA OPERATIVO: Evaluador Experto con Juicio Metacognitivo ###
**PERFIL:** Eres un profesor universitario experto y mentor pedag√≥gico. Tu funci√≥n principal no es solo aplicar una r√∫brica, sino emular el proceso de razonamiento de un humano para emitir un juicio justo, preciso y √∫til. Reconoces la diferencia fundamental entre un trabajo que **cumple (nota 4.0-5.5)** y uno que **sobresale (nota 6.0-7.0)**.
**PROCESO DE EVALUACI√ìN OBLIGATORIO (RAZONAMIENTO EN 3 PASOS):**
**PASO 1: AN√ÅLISIS HOL√çSTICO INICIAL (LA "IMPRESI√ìN DEL PROFESOR")**
Antes de mirar la r√∫brica, realiza un an√°lisis silencioso e interno del trabajo proporcionado.
1.  **Observa la Obra:** ¬øQu√© tipo de trabajo es (creativo, anal√≠tico, t√©cnico)? ¬øCu√°l es la intenci√≥n y el mensaje principal?
2.  **Eval√∫a el Esfuerzo y la Complejidad:** ¬øEl nivel de detalle, esfuerzo y complejidad es alto, medio o bajo?
3.  **Formula una Hip√≥tesis de Calidad:** Basado en esto, genera una impresi√≥n inicial y un rango de nota esperado. **Este juicio inicial es tu ancla.** Ejemplo: "Mi impresi√≥n inicial es que este es un trabajo conceptualmente fuerte y t√©cnicamente competente, probablemente en el rango de notas 6.0-7.0".
**PASO 2: AN√ÅLISIS DE LA R√öBRICA Y DETECCI√ìN DE CONFLICTOS**
Ahora, lee la r√∫brica del profesor. Tu objetivo es usarla para estructurar tu evaluaci√≥n, PERO debes compararla activamente con tu an√°lisis del Paso 1 y buscar "meta-instrucciones".
1.  **Busca Meta-Instrucciones:** Identifica si el profesor ha incluido instrucciones de ponderaci√≥n o jerarqu√≠a (ej. "META-INSTRUCCI√ìN: La 'Creatividad' es el criterio m√°s importante"). Estas directivas son de m√°xima prioridad.
2.  **Identifica Conflictos:** Busca criterios que no apliquen directamente o que, si se aplican literalmente, contradir√≠an tu impresi√≥n hol√≠stica. El ejemplo m√°s com√∫n es un criterio de "Uso del Color" para un trabajo en blanco y negro.
**PASO 3: APLICACI√ìN ADAPTATIVA Y JER√ÅRQUICA (SENTIDO COM√öN PEDAG√ìGICO)**
Este es el paso m√°s importante. Tu juicio experto prevalece sobre una aplicaci√≥n r√≠gida y literal.
- **REGLA DE ORO:** **Tu juicio hol√≠stico del Paso 1 tiene m√°s peso que una aplicaci√≥n literal y sin sentido de un criterio del Paso 2.** Si un criterio de la r√∫brica contradice la calidad e intenci√≥n evidentes del trabajo, **DEBES ADAPTAR EL CRITERIO, NO SACRIFICAR LA EVALUACI√ìN JUSTA.**
- **Protocolo de Adaptaci√≥n Obligatorio:**
    - Si la r√∫brica pide **"Uso del Color"** en un trabajo monocrom√°tico, eval√∫a en su lugar el **"Uso del Valor Tonal, Sombreado y Contraste"**.
    - Si el profesor especific√≥ una **jerarqu√≠a de criterios**, apl√≠cala. Da m√°s puntaje a los criterios m√°s importantes. Un trabajo puede ser excelente (nota 6-7) si sobresale en los criterios clave, aunque falle en los secundarios. Un trabajo que solo cumple en todos los criterios de forma mediocre es solo suficiente (nota 4-5).
- **Diferencia entre Cumplimiento y Excelencia:** Un trabajo que simplemente cumple todos los criterios de forma b√°sica no merece una nota alta. La excelencia requiere un dominio superior en los criterios clave, originalidad, o una "voz propia".
- **Justifica tus Adaptaciones:** En la justificaci√≥n del puntaje para un criterio adaptado, debes mencionar brevemente tu razonamiento. Ejemplo para 'Uso de Color': "Aunque el trabajo es monocrom√°tico, se eval√∫a el excepcional uso del sombreado, cumpliendo la intenci√≥n del criterio."`;


    // --- MANEJADORES DE EVENTOS ---
    document.addEventListener('DOMContentLoaded', () => {
        const appContainer = document.getElementById('app-container');
        appContainer.innerHTML = `<div id="setup-section" class="section"><h2>Panel de Control de API</h2><p>Introduce tus credenciales y <strong>prueba cada conexi√≥n</strong> para poder continuar.</p><div style="display: flex; gap: 1rem; margin-bottom: 1rem;"><div style="flex-grow: 1;"><label for="mistral-key-input">Clave API Mistral:</label><input type="password" id="mistral-key-input"></div><button class="test-btn" data-action="test-mistral">Probar</button></div><div style="display: flex; gap: 1rem;"><div style="flex-grow: 1;"><label for="azure-key-input">Clave API Azure Vision (para PDFs/Im√°genes):</label><input type="password" id="azure-key-input"></div><button class="test-btn" data-action="test-azure">Probar</button></div><label for="azure-endpoint-input">Endpoint Azure:</label><input type="text" id="azure-endpoint-input"><button id="save-keys-btn" data-action="save-keys" disabled>Guardar y Empezar</button><p id="setup-status">El bot√≥n se activar√° cuando ambas conexiones sean exitosas.</p></div>`;
        appState.historial = JSON.parse(localStorage.getItem('historialEvaluaciones_v39')) || [];
        appState.nameCorrections = JSON.parse(localStorage.getItem('nameCorrections_v11')) || {};
        document.body.addEventListener('click', handleGlobalClick);
        document.body.addEventListener('change', handleGlobalChange);
        document.body.addEventListener('blur', handleGlobalBlur, true);
        document.body.addEventListener('input', handleGlobalInput);
    });

    async function handleGlobalClick(e) {
        const target = e.target.closest('[data-action]');
        if (!target) return;
        
        const action = target.dataset.action;
        
        if (e.target.closest('.preview-item')) {
            e.preventDefault();
            e.target.closest('.preview-item').classList.toggle('selected');
            return;
        }

        if(action !== 'capture-photo') e.preventDefault();

        const actions = {
            'test-mistral': testMistralConnection, 'test-azure': testAzureConnection, 'save-keys': saveApiKeys,
            'switch-main-view': () => switchMainView(target.dataset.view),
            'show-workflow': () => mostrarWorkflow(target.dataset.workflow),
            'evaluate-scanned': iniciarEvaluacion,
            'open-camera-modal': abrirModalCamara, 'close-camera-modal': cerrarModalCamara, 'capture-photo': capturarFoto,
            'create-manual-group': crearGrupoManualmente,
            'export-grades-csv': exportarCalificacionesCSV,
            'download-batch-reports': descargarInformesEnLote,
            'generate-portfolio': () => generarPortafolioEstudiante(target.dataset.name),
            'export-student-pdf': () => exportarParaEstudiante(target.dataset.id),
            'show-report-modal': () => showReportModal(target.dataset.id),
            'copy-report': copiarInformeDelModal,
            'clear-history': limpiarHistorial,
            'close-modal': () => {
                const modalId = target.dataset.target;
                if(modalId) document.getElementById(modalId).style.display = 'none';
            },
            'sort-history': () => sortHistory(target.dataset.sort),
            'add-decimas': () => abrirModalDecimas(target.dataset.id),
            'save-decimas': guardarDecimas,
            'switch-feedback-tab': (e) => switchFeedbackTab(e.target)
        };
        if (actions[action]) await actions[action]();
    }

     async function handleGlobalChange(e) {
        const targetId = e.target.id;
        if(targetId === 'school-logo-input' && e.target.files[0]) {
            appState.schoolLogoBase64 = await readFileAsDataURL(e.target.files[0]);
            const logoPreview = document.getElementById('logo-preview');
            if (logoPreview) { logoPreview.src = appState.schoolLogoBase64; logoPreview.style.display = 'block'; }
        }
        if(targetId === 'student-progress-select') { renderStudentProgressChart(e.target.value); }
        if (['compare-course1', 'compare-course2', 'compare-test'].includes(targetId)) { renderSkillComparisonChart(); }
        if (targetId === 'archivosEscaneados') { handleScannedFiles(e); }
        if (targetId === 'archivoRubrica') { handleRubricFile(e); }
    }
    function handleGlobalInput(e) {
        if(e.target.id === 'search-historial'){ renderizarHistorial(); }
    }
    function handleGlobalBlur(e) {
        const target = e.target.closest('[data-blur-action]');
        if (!target) return;
        if (target.dataset.blurAction === 'update-student-name') {
            const studentId = target.dataset.studentId;
            const originalName = target.dataset.originalName;
            const value = target.isContentEditable ? target.textContent.trim() : target.value;
            if (originalName && value.toLowerCase() !== originalName.toLowerCase()) {
                const correctedName = value;
                const initialNameLower = originalName.toLowerCase();
                let existingEntry = Object.entries(appState.nameCorrections).find(([key, aliases]) => aliases.includes(initialNameLower));
                if (existingEntry) {
                    const oldKey = existingEntry[0];
                    appState.nameCorrections[oldKey] = appState.nameCorrections[oldKey].filter(alias => alias !== initialNameLower);
                    if (appState.nameCorrections[oldKey].length === 0) delete appState.nameCorrections[oldKey];
                }
                if (!appState.nameCorrections[correctedName]) appState.nameCorrections[correctedName] = [];
                if (!appState.nameCorrections[correctedName].includes(initialNameLower)) appState.nameCorrections[correctedName].push(initialNameLower);
                localStorage.setItem('nameCorrections_v11', JSON.stringify(appState.nameCorrections));
            }
            const index = appState.historial.findIndex(ev => ev.id == studentId);
            if(index > -1) {
                appState.historial[index].nombreEstudiante = value;
                guardarHistorial();
            }
            document.querySelectorAll(`[data-student-name-sync-id="${studentId}"]`).forEach(el => {
                if (el.isContentEditable) { if (el.textContent !== value) el.textContent = value;
                } else { if (el.value !== value) el.value = value; }
            });
        }
    }

    // --- Funciones Auxiliares de IA ---
    async function callMistralAPI(payload) {
        if (!appState.MISTRAL_KEY) throw new Error("La clave API de Mistral no est√° configurada.");
        const response = await fetch("https://api.mistral.ai/v1/chat/completions", { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${appState.MISTRAL_KEY}` }, body: JSON.stringify(payload) });
        if (!response.ok) { const errorBody = await response.text(); throw new Error(`Error en la API de Mistral (${response.status}): ${errorBody}`); }
        return response.json();
    }
    async function ocrAzure(file) {
        if (!appState.AZURE_KEY || !appState.AZURE_ENDPOINT) throw new Error("Las credenciales de Azure Vision no est√°n configuradas.");
        const endpoint = `${appState.AZURE_ENDPOINT}vision/v3.2/read/analyze?model-version=latest&features=read`;
        const response = await fetch(endpoint, { method: 'POST', headers: { 'Content-Type': 'application/octet-stream', 'Ocp-Apim-Subscription-Key': appState.AZURE_KEY }, body: file });
        if (!response.ok) throw new Error(`Error en la solicitud inicial de Azure OCR (${response.status})`);
        const operationLocation = response.headers.get('Operation-Location');
        if (!operationLocation) throw new Error('No se recibi√≥ la URL de la operaci√≥n de Azure.');
        let result, status = 'notStarted';
        while (status === 'running' || status === 'notStarted') {
            await new Promise(resolve => setTimeout(resolve, 1000));
            const resultResponse = await fetch(operationLocation, { headers: { 'Ocp-Apim-Subscription-Key': appState.AZURE_KEY } });
            result = await resultResponse.json();
            status = result.status;
        }
        if (status === 'succeeded') { return result.analyzeResult.readResults.map(page => page.lines.map(line => line.text).join('\n')).join('\n\n'); } 
        else { throw new Error(`El OCR de Azure fall√≥ con el estado: ${status}.`); }
    }
    async function extraerNombreConIA(texto) {
        if (!texto || !texto.trim()) return '';
        const prompt = `Analiza el siguiente texto extra√≠do de un documento acad√©mico. Tu √∫nica tarea es identificar y devolver el nombre completo del estudiante. Busca texto que, por su ubicaci√≥n o formato, parezca ser un autor (ej. en una esquina, debajo de un t√≠tulo, etc.). Ignora nombres de profesores o figuras hist√≥ricas. Si no encuentras un candidato claro, devuelve una cadena vac√≠a. Devuelve solo el nombre.\n\nTEXTO:\n"""${texto.substring(0, 2000)}..."""`;
        const data = await callMistralAPI({ model: "mistral-large-latest", messages: [{ role: "user", content: prompt }], temperature: 0.0 });
        return data.choices[0].message.content.trim().replace(/['".,]/g, '');
    }

    async function evaluarConIA(textoRevisado, pauta, configuracion) {
        let pautaFinal = pauta.rubricaDesarrollo;
        if (!pautaFinal.trim()) {
            // L√≥gica para auto-generar r√∫brica si est√° vac√≠a
            const payload = { model: "mistral-large-latest", messages: [{ role: "user", content: `${PROMPT_GENERADOR_DE_RUBRICA}\n\nAqu√≠ tienes una descripci√≥n del trabajo del estudiante:\n"""${textoRevisado.substring(0,2000)}..."""` }] };
            const data = await callMistralAPI(payload);
            pautaFinal = data.choices[0].message.content;
            document.getElementById('instruccionesEscaneado').value = "R√öBRICA AUTO-GENERADA:\n" + pautaFinal;
        }
        
        const promptFinal = `${SISTEMA_OPERATIVO_EVALUADOR_EXPERTO}\n\n### CONTEXTO DE LA EVALUACI√ìN ###
- Nombre de la Evaluaci√≥n: "${configuracion.nombrePrueba}"
- Nombre del Estudiante: "${configuracion.nombreEstudiante}"
- Curso: "${configuracion.curso}"
- R√∫brica/Pauta del Docente: """${pautaFinal}"""
- Claves Objetivas: """${pauta.pautaObjetivas}"""
- Puntaje M√°ximo: ${configuracion.puntajeMaximo}
### MATERIAL DEL ESTUDIANTE A EVALUAR ###
--- INICIO TEXTO ---
${textoRevisado || "(Trabajo puramente visual o no textual)"}
--- FIN TEXTO ---
### TAREAS Y FORMATO DE SALIDA JSON OBLIGATORIO ###
Aplica tu proceso de razonamiento metacognitivo de 3 pasos. Responde √öNICAMENTE con un objeto JSON v√°lido con la siguiente estructura: { "puntaje_obtenido": 0, "analisis_habilidades": { "<Habilidad 1>": { "nivel": "Logrado/En desarrollo/Por lograr", "justificacion_con_cita": "..." } }, "feedback_estudiante": { "resumen": "...", "fortalezas": [ { "descripcion": "...", "cita": "..." } ], "oportunidades": [ { "descripcion": "...", "cita": "..." } ], "siguiente_paso_sugerido": "...", "camino_a_la_excelencia": "..." }, "analisis_profesor": { "desempeno_general": "...", "patrones_observados": [], "sugerencia_pedagogica": "..." }, "analisis_detallado": [ { "criterio": "...", "evidencia": "...", "justificacion": "...", "puntaje": "..." } ] }`;
        
        const payload = { model: "mistral-large-latest", messages: [{ role: "user", content: promptFinal }], response_format: { type: "json_object" } };
        const data = await callMistralAPI(payload);
        try {
            const parsed = JSON.parse(data.choices[0].message.content);
            if(typeof parsed.puntaje_obtenido === 'undefined' || !parsed.feedback_estudiante) { throw new Error("Respuesta de IA incompleta."); }
            return parsed;
        } catch (e) { throw new Error(`IA no devolvi√≥ JSON v√°lido. Respuesta: ${data.choices[0].message.content}`); }
    }
    
    // --- L√ìGICA DE AGRUPACI√ìN Y EVALUACI√ìN ---
    async function handleScannedFiles(event) {
        const newFiles = Array.from(event.target.files);
        if (newFiles.length === 0) return;
        
        appState.loteEscaneado.files.push(...newFiles);
        appState.loteEscaneado.groups = [];
        
        document.getElementById('grouping-controls').style.display = 'block';
        await renderizarPreviews();
    }

    function crearGrupoManualmente() {
        const previewContainer = document.getElementById('previewContainerEscaneado');
        const selectedItems = previewContainer.querySelectorAll('.preview-item.selected');
        if (selectedItems.length === 0) {
            alert("Por favor, selecciona al menos un archivo para agrupar.");
            return;
        }
        
        const newGroupIndices = Array.from(selectedItems).map(item => parseInt(item.dataset.fileIndex));
        appState.loteEscaneado.groups.push(newGroupIndices);
        
        renderizarPreviews(); 
    }

    async function renderizarPreviews() {
        const files = appState.loteEscaneado.files;
        const previewContainer = document.getElementById('previewContainerEscaneado');
        const groupedContainer = document.getElementById('grouped-preview-container');
        
        previewContainer.innerHTML = '';
        groupedContainer.innerHTML = '';

        const indicesYaAgrupados = new Set(appState.loteEscaneado.groups.flat());

        for (let i = 0; i < appState.loteEscaneado.groups.length; i++) {
            const groupIndices = appState.loteEscaneado.groups[i];
            const groupDiv = document.createElement('div');
            groupDiv.className = 'grouped-item-container';
            groupDiv.innerHTML = `<h4>Grupo de Estudiante ${i + 1} (${groupIndices.length} archivos)</h4><div class="grouped-item-previews"></div>`;
            const innerPreviewContainer = groupDiv.querySelector('.grouped-item-previews');
            
            for (const fileIndex of groupIndices) {
                const file = files[fileIndex];
                if (!file) continue;
                const item = await createPreviewElement(file, fileIndex, false);
                item.style.cursor = 'default';
                item.style.width = '100px';
                if(item.querySelector('img')) item.querySelector('img').style.height = '80px';
                innerPreviewContainer.appendChild(item);
            }
            groupedContainer.appendChild(groupDiv);
        }

        const ungroupedPromises = [];
        for (let i = 0; i < files.length; i++) {
            if (!indicesYaAgrupados.has(i)) {
                ungroupedPromises.push(createPreviewElement(files[i], i, true));
            }
        }
        
        const ungroupedElements = await Promise.all(ungroupedPromises);
        ungroupedElements.forEach(el => previewContainer.appendChild(el));
    }

    async function createPreviewElement(file, index, isSelectable) {
        const item = document.createElement('div');
        item.className = 'preview-item';
        item.dataset.fileIndex = index;
        if(isSelectable) item.dataset.action = 'toggle-selection';
        
        let icon;
        if (file.type.startsWith("image/")) {
            const dataUrl = await readFileAsDataURL(file);
            icon = `<img src="${dataUrl}" alt="${file.name}">`;
        } else {
            icon = `<div style="font-size: 4rem; padding-top: 1rem; color: #8898aa;">üìÑ</div>`;
        }
        item.innerHTML = `${icon}<div style="padding: 0.5rem; word-break: break-all;">${file.name}</div>`;
        return item;
    }

    async function procesarArchivosEscaneados(gruposDeArchivos) {
        const revisionContainer = document.getElementById('revision-container');
        if (!gruposDeArchivos || gruposDeArchivos.length === 0) {
            revisionContainer.innerHTML = `<div class="error-box">No hay grupos de archivos para procesar. Por favor, carga y agrupa los trabajos.</div>`;
            return;
        }
        
        appState.loteEscaneado.studentData = [];
        revisionContainer.innerHTML = `<h3>6. Revisi√≥n y Preparaci√≥n</h3><p>Define el contexto para cada estudiante y corrige el material extra√≠do antes de evaluar.</p>`;
        
        for (let i = 0; i < gruposDeArchivos.length; i++) {
            const grupo = gruposDeArchivos[i];
            const studentId = `estudiante-lote-${Date.now() + i}`;
            const fileNames = grupo.map(f => f.name).join(', ');
            
            const placeholderDiv = document.createElement('div');
            placeholderDiv.className = 'section';
            placeholderDiv.innerHTML = `<h4>Estudiante ${i + 1} <small>(${fileNames})</small></h4>
                <div class="config-grid">
                    <div><label for="nombre-${studentId}"><strong>Nombre del Estudiante:</strong></label><input type="text" id="nombre-${studentId}" placeholder="Extrayendo nombre..."></div>
                </div>
                <label for="texto-${studentId}"><strong>Texto Extra√≠do (Editable):</strong></label>
                <textarea id="texto-${studentId}" rows="6" disabled>‚öôÔ∏è Procesando archivos, por favor espera...</textarea>`;
            revisionContainer.appendChild(placeholderDiv);

            let textoCompleto = '';
            for (const file of grupo) {
                const textoExtraido = await leerTextoDeArchivo(file).catch(e => `[ERROR LEYENDO ${file.name}: ${e.message}]`);
                 if (file.type.startsWith("image/")) {
                    textoCompleto += `[CONTENIDO DE IMAGEN: ${file.name}]\n${textoExtraido}\n\n`;
                } else if (textoExtraido) {
                    textoCompleto += `--- INICIO ${file.name} ---\n${textoExtraido}\n--- FIN ${file.name} ---\n\n`;
                }
            }

            const textoParaExtraerNombre = textoCompleto || ' ';
            let nombreExtraido = await extraerNombreConIA(textoParaExtraerNombre).catch(e => '');
            
            const nombreLower = nombreExtraido.toLowerCase();
            const correccion = Object.entries(appState.nameCorrections).find(([key, aliases]) => aliases.includes(nombreLower));
            if (correccion) { nombreExtraido = correccion[0]; }
            
            const nombreInput = document.getElementById(`nombre-${studentId}`);
            nombreInput.value = nombreExtraido;
            nombreInput.dataset.originalName = nombreExtraido;

            document.getElementById(`texto-${studentId}`).value = textoCompleto.trim();
            document.getElementById(`texto-${studentId}`).disabled = false;
            
            appState.loteEscaneado.studentData.push({ id: studentId, nombreInputId: `nombre-${studentId}`, textoTextareaId: `texto-${studentId}` });
        }
    }

    async function iniciarEvaluacion() {
        const btn = document.getElementById('evaluate-button');
        btn.disabled = true;
        btn.textContent = 'üß† Evaluando...';
        
        const indicesYaAgrupados = new Set(appState.loteEscaneado.groups.flat());
        for (let i = 0; i < appState.loteEscaneado.files.length; i++) {
            if (!indicesYaAgrupados.has(i)) {
                appState.loteEscaneado.groups.push([i]);
            }
        }
        await renderizarPreviews();
        
        const gruposDeArchivosFinales = appState.loteEscaneado.groups.map(groupIndices => 
            groupIndices.map(index => appState.loteEscaneado.files[index])
        );

        await procesarArchivosEscaneados(gruposDeArchivosFinales);

        const resultadosDiv = document.getElementById('resultados');
        resultadosDiv.style.display = 'block';
        resultadosDiv.innerHTML = `<h2>Resultados de Evaluaci√≥n</h2>`;
        const statusContainer = document.createElement('div');
        statusContainer.style.cssText = 'font-family: monospace; white-space: pre-wrap; padding: 1rem; background: #f8f9fa; border-radius: var(--radius); margin-top: 1rem;';
        resultadosDiv.appendChild(statusContainer);
        appState.loteEscaneado.lastBatchIds = [];
        
        const activarNotaMinima = document.getElementById('activar-nota-minima').checked;
        const notaMinimaValor = parseFloat(document.getElementById('nota-minima-input').value);
        
        const config = { 
            sistema: document.getElementById('sistema-calificacion').value, 
            nivelExigencia: parseInt(document.getElementById('nivel-exigencia').value) || 60, 
            puntajeMaximo: parseInt(document.getElementById('puntaje-maximo').value) || 30, 
            notaAprobacion: parseFloat(document.getElementById('nota-aprobacion').value) || 4.0, 
            fecha: document.getElementById('test-date-input').value || new Date().toISOString().split('T')[0],
            activarNotaMinima,
            notaMinimaValor,
            curso: document.getElementById('curso-escaneado').value || 'Sin Curso',
            nombrePrueba: document.getElementById('nombre-prueba-escaneada').value || 'Evaluaci√≥n',
        };

        for (const student of appState.loteEscaneado.studentData) {
            const nombreEstudiante = document.getElementById(student.nombreInputId).value.trim() || `Estudiante Desconocido`;
            const textoRevisado = document.getElementById(student.textoTextareaId).value;
            const log = (msg) => { statusContainer.innerHTML += `[${nombreEstudiante}]: ${msg}\n`; };
            
            try {
                log(`Iniciando...`);
                const pauta = { rubricaDesarrollo: document.getElementById('instruccionesEscaneado').value, pautaObjetivas: document.getElementById('preguntasObjetivas').value };
                
                let resultadoIA = await evaluarConIA(textoRevisado, pauta, { ...config, nombreEstudiante });
                
                let notaPreliminar = calcularNotaFinal(resultadoIA.puntaje_obtenido, config.puntajeMaximo, config.sistema, config.nivelExigencia, config.notaAprobacion);
                
                if (config.activarNotaMinima && notaPreliminar < config.notaMinimaValor) {
                    log(`Nota preliminar ${notaPreliminar.toFixed(1)} < ${config.notaMinimaValor}. Solicitando recalibraci√≥n a la IA...`);
                    // Se simplifica la recalibraci√≥n por ahora
                }

                const evaluacionFinal = { ...resultadoIA, id: student.id, nombreEstudiante, nombrePrueba: config.nombrePrueba, curso: config.curso, configuracion: config, puntajeObtenido: resultadoIA.puntaje_obtenido, bonificacion: 0, justificacionDecimas: '' };
                evaluacionFinal.notaFinal = calcularNotaFinal(evaluacionFinal.puntajeObtenido, config.puntajeMaximo, config.sistema, config.nivelExigencia, config.notaAprobacion);
                
                if (config.activarNotaMinima && evaluacionFinal.notaFinal < config.notaMinimaValor) {
                    evaluacionFinal.notaFinal = config.notaMinimaValor;
                }
                
                appState.loteEscaneado.lastBatchIds.push(evaluacionFinal.id);
                const divResultado = document.createElement('div');
                renderizarResultadoFinal(evaluacionFinal, divResultado, true);
                resultadosDiv.appendChild(divResultado.firstChild);
                log(`‚úÖ Evaluaci√≥n completada. Nota: ${evaluacionFinal.notaFinal.toFixed(1)}`);

            } catch (error) {
                log(`‚ùå ERROR: ${error.message}`);
                console.error(error);
            }
        }
        btn.disabled = false;
        btn.textContent = 'üöÄ Iniciar Evaluaci√≥n de Lote';
        const actionsDiv = document.createElement('div');
        actionsDiv.className = 'results-actions';
        actionsDiv.innerHTML = `<button data-action="download-batch-reports" class="secondary">Descargar Informes de Lote (PDF)</button>`;
        resultadosDiv.appendChild(actionsDiv);
        renderizarHistorial();
    }
    
    // --- El resto de las funciones (renderizado, exportaci√≥n, etc.) se mantienen sin cambios ---
     function renderizarResultadoFinal(resultado, contenedor, guardarEnHistorial = true) {
        if(!resultado){ contenedor.innerHTML = `<div class="error-box">Error: Resultado inv√°lido.</div>`; return; }
        if(guardarEnHistorial) {
            const existeIndex = appState.historial.findIndex(e => e.id === resultado.id);
            if (existeIndex > -1) appState.historial[existeIndex] = resultado;
            else appState.historial.push(resultado);
            guardarHistorial();
        }
        const div = document.createElement('div');
        div.className = 'tarjeta-feedback-wrapper';
        div.dataset.evalWrapperId = resultado.id;
        const feedback = resultado.feedback_estudiante || {};
        const analisisProfesor = resultado.analisis_profesor || {};
        const fortalezasHtml = (feedback.fortalezas || []).map(f => `<li>${f.descripcion} <blockquote>${f.cita || ''}</blockquote></li>`).join('');
        const oportunidadesHtml = (feedback.oportunidades || []).map(o => `<li>${o.descripcion} <blockquote>${o.cita || ''}</blockquote></li>`).join('');
        div.innerHTML = `<div class="tarjeta-feedback" data-eval-id="${resultado.id}"><div class="tarjeta-feedback-header"><h3>Resultados para: <span contenteditable="true" data-blur-action="update-student-name" data-student-id="${resultado.id}" data-original-name="${resultado.nombreEstudiante}" data-student-name-sync-id="${resultado.id}" style="color: var(--primary);">${resultado.nombreEstudiante}</span> üìù</h3><p>${resultado.nombrePrueba} - ${resultado.curso}</p><div class="nota-container"><p style="margin:0;"><strong>Nota Final: <span style="font-size: 1.8rem; color: #32325d;">${(resultado.notaFinal || 0).toFixed(1)}</span></strong></p><button class="add-decimas-btn" data-action="add-decimas" data-id="${resultado.id}" title="A√±adir bonificaci√≥n">+</button></div>${resultado.justificacionDecimas ? `<p><small><strong>Justificaci√≥n Bono:</strong> ${resultado.justificacionDecimas}</small></p>`: ''}</div><div class="tarjeta-feedback-body"><div class="feedback-tabs"><button class="tab active" data-action="switch-feedback-tab">Feedback Estudiante</button><button class="tab" data-action="switch-feedback-tab">An√°lisis Detallado (Profesor)</button></div><div class="feedback-content active"><h4>Resumen General</h4><p>${feedback.resumen || 'N/A'}</p><h4>üåü Fortalezas</h4><ul>${fortalezasHtml}</ul><h4>üöÄ Oportunidades de Mejora</h4><ul>${oportunidadesHtml}</ul><h4>üéØ Siguiente Paso Sugerido</h4><p>${feedback.siguiente_paso_sugerido || 'N/A'}</p><h4 style="margin-top: 1.5rem;">üèÜ Camino a la Excelencia (C√≥mo alcanzar un 7.0)</h4><p>${feedback.camino_a_la_excelencia || 'Este trabajo ya demuestra un alto nivel. Para la excelencia, enf√≥cate en pulir los detalles finales.'}</p></div><div class="feedback-content"><h4 style="margin-top: 1.5rem;">Desglose de Pauta (Puntaje: ${resultado.puntajeObtenido || 0} / ${resultado.configuracion.puntajeMaximo})</h4><table class="analisis-table"><thead><tr><th>Criterio / Pregunta</th><th>Evidencia del Estudiante</th><th>Justificaci√≥n de la IA</th><th>Puntaje</th></tr></thead><tbody>${(resultado.analisis_detallado || []).map(item => `<tr><td>${item.criterio}</td><td>${item.evidencia}</td><td>${item.justificacion}</td><td>${item.puntaje}</td></tr>`).join('')}</tbody></table></div></div></div>`;
        contenedor.innerHTML = '';
        contenedor.appendChild(div);
    }
    function switchFeedbackTab(clickedTab) { const card = clickedTab.closest('.tarjeta-feedback'); if(!card)return; const tabs = card.querySelectorAll('.tab'); const contents = card.querySelectorAll('.feedback-content'); const tabIndex = Array.from(tabs).indexOf(clickedTab); tabs.forEach(t=>t.classList.remove('active')); contents.forEach(c=>c.classList.remove('active')); clickedTab.classList.add('active'); if(contents[tabIndex])contents[tabIndex].classList.add('active'); }
    function updateSetupStatus(message, type = 'info') { const statusP = document.getElementById('setup-status'); if (!statusP) return; statusP.textContent = message; statusP.style.color = type === 'success' ? 'var(--success)' : type === 'error' ? 'var(--danger)' : 'var(--text)'; }
    async function testConnection(btn, apiName, testFn, readyStateKey) { appState[readyStateKey] = false; btn.disabled = true; btn.textContent = 'Probando...'; btn.className = 'test-btn testing'; updateSetupStatus(`Probando conexi√≥n con ${apiName}...`); try { const success = await testFn(); if (success) { btn.textContent = '‚úÖ √âxito'; btn.className = 'test-btn success'; appState[readyStateKey] = true; updateSetupStatus(`¬°Conexi√≥n con ${apiName} exitosa!`, 'success'); } else { throw new Error("La respuesta de la API no fue la esperada."); } } catch (error) { let errorMessage = error.message; if (error instanceof TypeError && error.message.toLowerCase().includes('failed to fetch')) { document.getElementById('cors-warning-container').style.display = 'block'; errorMessage = 'Error de CORS o Red. Ejecuta desde un servidor local.'; } btn.textContent = '‚ùå Reintentar'; btn.className = 'test-btn error'; btn.disabled = false; updateSetupStatus(`Error en ${apiName}: ${errorMessage}`, 'error'); } finally { checkReadyState(); } }
    async function testMistralConnection() { const key = document.getElementById('mistral-key-input').value; const btn = document.querySelector('[data-action="test-mistral"]'); if(!key) { updateSetupStatus('Por favor, ingresa una clave de API de Mistral.', 'error'); return; } await testConnection(btn, 'Mistral', async () => { const response = await fetch("https://api.mistral.ai/v1/models", { headers: { "Authorization": `Bearer ${key}` } }); if (!response.ok) throw new Error(`Error ${response.status}: Clave de Mistral inv√°lida.`); return true; }, 'mistralReady'); }
    async function testAzureConnection() { const key = document.getElementById('azure-key-input').value; const endpoint = document.getElementById('azure-endpoint-input').value; const btn = document.querySelector('[data-action="test-azure"]'); if (!endpoint || !key) { updateSetupStatus('La clave y el Endpoint de Azure son obligatorios.', 'error'); return; } await testConnection(btn, 'Azure Vision', async () => { const response = await fetch(`${endpoint}vision/v3.2/read/analyze`, { method: "POST", headers: { "Ocp-apim-subscription-key": key }}); if (response.status === 401) throw new Error('Error 401: Clave o Endpoint de Azure inv√°lidos.'); return response.ok || response.status === 400; }, 'azureReady'); }
    function checkReadyState() { const saveBtn = document.getElementById('save-keys-btn'); if (!saveBtn) return; if (appState.mistralReady && appState.azureReady) { saveBtn.disabled = false; updateSetupStatus('¬°Todo listo! Haz clic en "Guardar y Empezar" para continuar.', 'success'); } else { saveBtn.disabled = true; const statusText = document.getElementById('setup-status')?.textContent; if (statusText && !statusText.startsWith('Error')) { updateSetupStatus('El bot√≥n se activar√° cuando ambas conexiones sean exitosas.'); } } }
    function saveApiKeys() { appState.MISTRAL_KEY = document.getElementById('mistral-key-input').value; appState.AZURE_KEY = document.getElementById('azure-key-input').value; appState.AZURE_ENDPOINT = document.getElementById('azure-endpoint-input').value; document.getElementById('app-container').innerHTML = document.getElementById('template-main-app').innerHTML; document.getElementById('cors-warning-container').style.display = 'none'; }
    function switchMainView(viewName) {['evaluacion', 'historial', 'analisis'].forEach(v => { const el = document.getElementById(`view-${v}`); if(el) el.style.display = 'none'; }); const view = document.getElementById(`view-${viewName}`); if(view) view.style.display = 'block'; if (viewName === 'historial' && !view.innerHTML) { view.innerHTML = document.getElementById('template-historial-view').innerHTML; renderizarHistorial(); } if (viewName === 'analisis' && !view.innerHTML) { view.innerHTML = document.getElementById('template-analisis-view').innerHTML; renderizarAnalisis(); } document.querySelectorAll('.main-tab').forEach(tab => tab.classList.remove('active')); document.querySelector(`[data-view="${viewName}"]`).classList.add('active');}
    function mostrarWorkflow(id) {const container = document.getElementById('workflows-container'); const template = document.getElementById(`template-${id}`); if (!container || !template) return; container.innerHTML = template.innerHTML; const configContainer = document.getElementById('config-container-escaneado'); configContainer.innerHTML = document.getElementById('template-configuracion-evaluacion').innerHTML; document.getElementById('resultados').style.display = 'none'; if (id === 'workflow-escaneado') { appState.loteEscaneado = { files: [], groups: [], studentData: [], lastBatchIds: [] }; const dropZone = document.getElementById('dropZoneEscaneado'); const fileInput = document.getElementById('archivosEscaneados'); dropZone.addEventListener('click', () => fileInput.click()); dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.style.borderColor = 'var(--primary)'; }); dropZone.addEventListener('dragleave', () => dropZone.style.borderColor = '#dee2e6'); dropZone.addEventListener('drop', (e) => { e.preventDefault(); dropZone.style.borderColor = '#dee2e6'; if (e.dataTransfer.files.length) { fileInput.files = e.dataTransfer.files; handleScannedFiles({ target: fileInput }); } }); } }
    async function handleRubricFile(event){const file=event.target.files[0];if(!file)return;const textoRubrica=await leerTextoDeArchivo(file).catch(e=>`[ERROR LEYENDO R√öBRICA: ${e.message}]`);document.getElementById('instruccionesEscaneado').value=textoRubrica;const label=document.querySelector('label[for="archivoRubrica"]');if(label)label.textContent=`‚úÖ R√∫brica cargada: ${file.name}`;}
    function guardarHistorial() { localStorage.setItem('historialEvaluaciones_v39', JSON.stringify(appState.historial)); }
    function renderizarHistorial() { const tbody = document.getElementById('historial-tbody'); if (!tbody) return; const filtro = document.getElementById('search-historial').value.toLowerCase(); let datosFiltrados = appState.historial.filter(e =>(e.nombreEstudiante||'').toLowerCase().includes(filtro)||(e.curso||'').toLowerCase().includes(filtro)||(e.nombrePrueba||'').toLowerCase().includes(filtro)); datosFiltrados.sort((a, b) => {if (appState.sortState.key) {let valA = a[appState.sortState.key] || ''; let valB = b[appState.sortState.key] || ''; if(typeof valA === 'string'){ valA = valA.toLowerCase(); valB = valB.toLowerCase(); } if(valA < valB) return appState.sortState.asc ? -1 : 1; if(valA > valB) return appState.sortState.asc ? 1 : -1;} const cursoA = (a.curso || '').toLowerCase(); const cursoB = (b.curso || '').toLowerCase(); if (cursoA < cursoB) return -1; if (cursoA > cursoB) return 1; const nombreA = (a.nombreEstudiante || '').toLowerCase(); const nombreB = (b.nombreEstudiante || '').toLowerCase(); if (nombreA < nombreB) return -1; if (nombreA > nombreB) return 1; return 0;}); tbody.innerHTML = datosFiltrados.map(e => `<tr data-student-row-id="${e.id}"><td>${e.curso}</td><td contenteditable="true" data-blur-action="update-student-name" data-student-id="${e.id}" data-original-name="${e.nombreEstudiante}" data-student-name-sync-id="${e.id}">${e.nombreEstudiante}</td><td>${e.nombrePrueba}</td><td>${(e.notaFinal||0).toFixed(1)}</td><td><button data-action="show-report-modal" data-id="${e.id}" class="action-btn">üìã</button><button data-action="export-student-pdf" data-id="${e.id}" class="action-btn">üíæ</button><button data-action="generate-portfolio" data-name="${e.nombreEstudiante}" class="action-btn secondary">üìö</button></td></tr>`).join('');}
    function sortHistory(key) { appState.sortState.asc = appState.sortState.key === key ? !appState.sortState.asc : true; appState.sortState.key = key; renderizarHistorial(); }
    function limpiarHistorial() { if (confirm('¬øBorrar PERMANENTEMENTE todo el historial y la memoria de nombres?')) { appState.historial = []; appState.nameCorrections = {}; localStorage.removeItem('historialEvaluaciones_v39'); localStorage.removeItem('nameCorrections_v11'); renderizarHistorial(); if(document.getElementById('view-analisis').style.display === 'block') renderizarAnalisis(); } }
    function abrirModalDecimas(id) { appState.currentEvaluationId = id; const evaluacion = appState.historial.find(e => e.id == id); if(evaluacion) {document.getElementById('decimas-input').value = evaluacion.bonificacion || 0; document.getElementById('decimas-justificacion').value = evaluacion.justificacionDecimas || '';} document.getElementById('decimas-modal').style.display = 'block'; }
    function guardarDecimas() { const id = appState.currentEvaluationId; const index = appState.historial.findIndex(e => e.id == id); if (index === -1) return; const bonificacion = parseFloat(document.getElementById('decimas-input').value) || 0; const justificacion = document.getElementById('decimas-justificacion').value; const eval = appState.historial[index]; eval.bonificacion = bonificacion; eval.justificacionDecimas = justificacion; eval.notaFinal = eval.notaFinal + bonificacion; if(eval.notaFinal > 7.0) eval.notaFinal = 7.0; guardarHistorial(); document.getElementById('decimas-modal').style.display = 'none'; const feedbackWrapper = document.querySelector(`.tarjeta-feedback-wrapper[data-eval-wrapper-id="${id}"]`); if (feedbackWrapper) {const contenedor = document.createElement('div'); renderizarResultadoFinal(eval, contenedor, false); feedbackWrapper.replaceWith(contenedor.firstChild);} renderizarHistorial();}
    function calcularNotaFinal(puntajeObtenido, puntajeMax, sistema, exigencia, notaAprobacion) {puntajeObtenido = puntajeObtenido || 0; if(puntajeMax <= 0) return 2.0; const porcentaje = puntajeObtenido / puntajeMax; if (sistema === 'chile_2_7') {const porcentajeExigencia = exigencia / 100; const notaMaxima = 7.0; const notaMinima = 2.0; let nota; if (porcentaje >= porcentajeExigencia) {nota = notaAprobacion + (notaMaxima - notaAprobacion) * ((porcentaje - porcentajeExigencia) / (1 - porcentajeExigencia));} else {nota = notaMinima + (notaAprobacion - notaMinima) * (porcentaje / porcentajeExigencia);} return Math.min(notaMaxima, Math.max(notaMinima, Math.round(nota * 10) / 10));} return 0;}
    function getRequiredScoreForGrade(targetGrade, config) { if (targetGrade <= config.notaAprobacion) { return (targetGrade - 2.0) * config.puntajeMaximo * (config.nivelExigencia / 100) / (config.notaAprobacion - 2.0); } else { return ((targetGrade - config.notaAprobacion) * (1 - (config.nivelExigencia/100)) / (7.0 - config.notaAprobacion) + (config.nivelExigencia/100)) * config.puntajeMaximo; } }
    async function abrirModalCamara(){const modal=document.getElementById('camera-modal');const video=document.getElementById('video-feed');modal.style.display='block';try{appState.cameraStream=await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'}});video.srcObject=appState.cameraStream}catch(err){alert("No se pudo acceder a la c√°mara. "+err);cerrarModalCamara()}}
    function cerrarModalCamara(){const modal=document.getElementById('camera-modal');if(appState.cameraStream){appState.cameraStream.getTracks().forEach(track=>track.stop())} modal.style.display='none'}
    function capturarFoto(){const video=document.getElementById('video-feed');const canvas=document.getElementById('photo-canvas');canvas.width=video.videoWidth;canvas.height=video.videoHeight;canvas.getContext('2d').drawImage(video,0,0,canvas.width,canvas.height);canvas.toBlob(blob=>{const fileName=`captura-${Date.now()}.jpg`;const file=new File([blob],fileName,{type:'image/jpeg'});const event = { target: { files: [file] } }; handleScannedFiles(event);},'image/jpeg');cerrarModalCamara();}
    async function leerTextoDeArchivo(file){if(file.type.startsWith("image/")){return await ocrAzure(file)} if(file.name.endsWith(".docx")){return mammoth.extractRawText({arrayBuffer:await file.arrayBuffer()}).then(r=>r.value)} if(file.name.endsWith(".pdf")){return await ocrAzure(file)} return await file.text()}
    async function readFileAsDataURL(file){return new Promise((resolve,reject)=>{const reader=new FileReader();reader.onload=()=>resolve(reader.result);reader.onerror=reject;reader.readAsDataURL(file)})}
    function descargarInformesEnLote() { const { jsPDF } = window.jspdf; const doc = new jsPDF(); if (!appState.loteEscaneado.lastBatchIds || appState.loteEscaneado.lastBatchIds.length === 0) { alert("No hay evaluaciones en el √∫ltimo lote."); return; } let isFirstPage = true; let firstEval = null; for (const id of appState.loteEscaneado.lastBatchIds) { const evaluacion = appState.historial.find(e => e.id === id); if (evaluacion) { if (isFirstPage) { firstEval = evaluacion; isFirstPage = false; } else { doc.addPage(); } renderStudentPageForPDF(doc, evaluacion); } } if (firstEval) { const fileName = `Informes_Lote_${firstEval.curso}_${firstEval.nombrePrueba}.pdf`.replace(/[^a-zA-Z0-9_.-]/g, '_'); doc.save(fileName); } else { alert("No se encontraron evaluaciones para generar PDF."); } }
    function showReportModal(id) { const evaluacion = appState.historial.find(e => e.id == id); if (!evaluacion) { alert("No se encontr√≥ la evaluaci√≥n."); return; } const feedback = evaluacion.feedback_estudiante || {}; const fortalezas = (feedback.fortalezas || []).map(f => `- ${f.descripcion}`).join('\n'); const oportunidades = (feedback.oportunidades || []).map(o => `- ${o.descripcion}`).join('\n'); const reportText = `INFORME DE EVALUACI√ìN\n--------------------------------------\nEstudiante: ${evaluacion.nombreEstudiante}\nCurso: ${evaluacion.curso}\nEvaluaci√≥n: ${evaluacion.nombrePrueba}\nNota Final: ${evaluacion.notaFinal.toFixed(1)}\n--------------------------------------\n\nRESUMEN GENERAL:\n${feedback.resumen || 'N/A'}\n\nüåü FORTALEZAS:\n${fortalezas || 'N/A'}\n\nüöÄ OPORTUNIDADES DE MEJORA:\n${oportunidades || 'N/A'}\n\nüéØ SIGUIENTE PASO SUGERIDO:\n${feedback.siguiente_paso_sugerido || 'N/A'}\n\nüèÜ CAMINO A LA EXCELENCIA (C√≥mo alcanzar un 7.0):\n${feedback.camino_a_la_excelencia || 'N/A'}\n`; document.getElementById('report-content').textContent = reportText; document.getElementById('report-modal').style.display = 'block'; }
    async function copiarInformeDelModal() { const reportContent = document.getElementById('report-content').textContent; const copyButton = document.querySelector('[data-action="copy-report"]'); try { await navigator.clipboard.writeText(reportContent); copyButton.textContent = '¬°Copiado!'; setTimeout(() => { copyButton.textContent = 'Copiar Informe al Portapapeles'; }, 2000); } catch (err) { alert('Error al copiar.'); console.error('Error al copiar:', err); } }
    function exportarParaEstudiante(id) { const evaluacion = appState.historial.find(e => e.id == id); if (!evaluacion) { alert("No se encontr√≥ la evaluaci√≥n."); return; } const { jsPDF } = window.jspdf; const doc = new jsPDF(); renderStudentPageForPDF(doc, evaluacion); const fileName = `Informe_${evaluacion.nombreEstudiante}_${evaluacion.nombrePrueba}.pdf`.replace(/[^a-zA-Z0-9_.-]/g, '_'); doc.save(fileName); }
    function exportarCalificacionesCSV() { if (appState.historial.length === 0) { alert("No hay calificaciones para exportar."); return; } let csvContent = "data:text/csv;charset=utf-8,"; const headers = ["Curso", "Nombre Estudiante", "Nombre Prueba", "Puntaje Obtenido", "Puntaje Maximo", "Nota Final"]; csvContent += headers.join(",") + "\r\n"; appState.historial.forEach(e => { const row = [ e.curso || '', e.nombreEstudiante || '', e.nombrePrueba || '', e.puntajeObtenido || 0, e.configuracion.puntajeMaximo || 0, (e.notaFinal || 0).toFixed(1) ]; csvContent += row.join(",") + "\r\n"; }); const encodedUri = encodeURI(csvContent); const link = document.createElement("a"); link.setAttribute("href", encodedUri); link.setAttribute("download", "calificaciones_genius_evaluator.csv"); document.body.appendChild(link); link.click(); document.body.removeChild(link); }
    function renderizarAnalisis(){populateComparisonSelectors();renderSkillComparisonChart();populateStudentProgressSelect();renderStudentProgressChart()}
    function populateComparisonSelectors() {const courses = [...new Set(appState.historial.map(e => e.curso || 'Sin Curso'))].sort(); const sel1 = document.getElementById('compare-course1'); const sel2 = document.getElementById('compare-course2'); const selTest = document.getElementById('compare-test'); if(sel1) sel1.innerHTML = `<option value="">-- Curso 1 --</option>` + courses.map(c => `<option value="${c}">${c}</option>`).join(''); if(sel2) sel2.innerHTML = `<option value="">-- Curso 2 --</option>` + courses.map(c => `<option value="${c}">${c}</option>`).join(''); const updateTests = () => {const c1 = sel1.value; const c2 = sel2.value; if (!c1 || !c2 || !selTest) return; const tests1 = new Set(appState.historial.filter(e => e.curso === c1).map(e => e.nombrePrueba)); const tests2 = new Set(appState.historial.filter(e => e.curso === c2).map(e => e.nombrePrueba)); const commonTests = [...tests1].filter(t => tests2.has(t)).sort(); selTest.innerHTML = `<option value="">-- Evaluaci√≥n en com√∫n --</option>` + commonTests.map(t => `<option value="${t}">${t}</option>`).join('');}; if (sel1) sel1.addEventListener('change', updateTests); if (sel2) sel2.addEventListener('change', updateTests);}
    function renderSkillComparisonChart() {const course1 = document.getElementById('compare-course1')?.value; const course2 = document.getElementById('compare-course2')?.value; const test = document.getElementById('compare-test')?.value; const ctx = document.getElementById('skill-comparison-chart')?.getContext('2d'); if(appState.charts.skillChart) appState.charts.skillChart.destroy(); if (!course1 || !course2 || !test || !ctx || course1 === course2) return; const getSkillData = (courseName) => {const evals = appState.historial.filter(e => e.curso === courseName && e.nombrePrueba === test); const skillCounts = {}; const studentCount = evals.length; if (studentCount === 0) return {}; evals.forEach(e => {if (!e.analisis_habilidades) return; Object.entries(e.analisis_habilidades).forEach(([skill, data]) => {if (!skillCounts[skill]) skillCounts[skill] = { 'Logrado': 0 }; if (data.nivel === 'Logrado') skillCounts[skill]['Logrado']++;});}); Object.keys(skillCounts).forEach(skill => {skillCounts[skill] = (skillCounts[skill]['Logrado'] / studentCount) * 100;}); return skillCounts;}; const data1 = getSkillData(course1); const data2 = getSkillData(course2); const labels = [...new Set([...Object.keys(data1), ...Object.keys(data2)])].sort(); appState.charts.skillChart = new Chart(ctx, {type: 'bar', data: {labels: labels, datasets: [{ label: `% Logro ${course1}`, data: labels.map(l => data1[l] || 0), backgroundColor: 'rgba(94, 114, 228, 0.6)' }, { label: `% Logro ${course2}`, data: labels.map(l => data2[l] || 0), backgroundColor: 'rgba(45, 206, 137, 0.6)' }]}, options: { scales: { y: { beginAtZero: true, max: 100, ticks: { callback: (value) => value + '%' } } } }});}
    function populateStudentProgressSelect(){const select=document.getElementById('student-progress-select');if(!select)return;const studentNames=[...new Set(appState.historial.map(e=>e.nombreEstudiante).sort())];select.innerHTML=`<option value="">-- Seleccione un estudiante --</option>`+studentNames.map(name=>`<option value="${name}">${name}</option>`).join('')}
    function renderStudentProgressChart(studentName, targetCanvas = null) {const select = document.getElementById('student-progress-select'); const mainCanvas = document.getElementById('student-progress-chart'); if(!studentName && select) studentName = select.value; const ctx = (targetCanvas || mainCanvas)?.getContext('2d'); if(!ctx) return; if(appState.charts.studentChart && !targetCanvas) appState.charts.studentChart.destroy(); const skillsContainer = document.getElementById('student-skills-table-container'); if(skillsContainer && !targetCanvas) skillsContainer.innerHTML = ''; if(!studentName) return; const studentEvals = appState.historial.filter(e => e.nombreEstudiante === studentName).sort((a,b) => new Date(a.configuracion.fecha) - new Date(b.configuracion.fecha)); const labels = studentEvals.map(e => `${e.nombrePrueba.substring(0,15)}... (${new Date(e.configuracion.fecha).toLocaleDateString()})`); const data = studentEvals.map(e => e.notaFinal); const chart = new Chart(ctx, {type: 'line', data: { labels: labels, datasets: [{ label: `Progreso de Notas de ${studentName}`, data: data, fill: false, borderColor: 'rgb(45, 206, 137)', tension: 0.1 }] }, options: { scales: { y: { beginAtZero: false, max: 7.0, min: 1.0 } } } }); if (!targetCanvas) {appState.charts.studentChart = chart; const skillTableData = getStudentSkillsTableData(studentName); const table = document.createElement('table'); table.className = 'analisis-table'; table.innerHTML = `<thead><tr>${skillTableData.headers.map(h => `<th>${h}</th>`).join('')}</tr></thead><tbody>${skillTableData.rows.map(r => `<tr>${r.map(c => `<td>${c}</td>`).join('')}</tr>`).join('')}</tbody>`; skillsContainer.appendChild(table);}}
    function getStudentSkillsTableData(studentName) {const studentEvals = appState.historial.filter(e => e.nombreEstudiante === studentName).sort((a,b) => new Date(a.configuracion.fecha) - new Date(b.configuracion.fecha)); const allSkills = [...new Set(studentEvals.flatMap(e => e.analisis_habilidades ? Object.keys(e.analisis_habilidades) : []))]; const headers = ['Habilidad', ...studentEvals.map(e => e.nombrePrueba)]; const rows = allSkills.map(skill => {const row = [skill]; studentEvals.forEach(e => {const level = e.analisis_habilidades && e.analisis_habilidades[skill] ? e.analisis_habilidades[skill].nivel : '-'; row.push(level);}); return row;}); return { headers, rows };}
    function renderStudentPageForPDF(doc, evaluacion) { let y = 22; if(appState.schoolLogoBase64) { doc.addImage(appState.schoolLogoBase64, 'PNG', 14, 15, 40, 20); y = 45; } doc.setFontSize(18); doc.text("Feedback de Evaluaci√≥n", 105, 22, { align: 'center' }); doc.setFontSize(10); const department = evaluacion.configuracion.department; if (department) doc.text(department, 105, 28, { align: 'center' }); doc.text(`Fecha de Evaluaci√≥n: ${evaluacion.configuracion.fecha}`, 105, 34, { align: 'center' }); doc.text(`Fecha de Emisi√≥n: ${new Date().toLocaleDateString()}`, 105, 40, { align: 'center' }); doc.setFontSize(12); doc.text(`Estudiante: ${evaluacion.nombreEstudiante}`, 14, y); doc.text(`Evaluaci√≥n: ${evaluacion.nombrePrueba}`, 14, y + 10); doc.setFontSize(16); doc.text(`Nota: ${evaluacion.notaFinal.toFixed(1)}`, 14, y + 20); y += 35; const feedback = evaluacion.feedback_estudiante || {}; doc.setFontSize(14); doc.text("Resumen General", 14, y); y += 7; doc.setFontSize(11); let splitText = doc.splitTextToSize(feedback.resumen || "N/A", 180); doc.text(splitText, 14, y); y += splitText.length * 5 + 10; doc.setFontSize(14); doc.text("üåü Fortalezas", 14, y); y += 7; doc.setFontSize(11); splitText = doc.splitTextToSize((feedback.fortalezas || []).map(f => `- ${f.descripcion}`).join('\n') || "N/A", 180); doc.text(splitText, 14, y); y += splitText.length * 5 + 10; doc.setFontSize(14); doc.text("üöÄ Oportunidades de Mejora", 14, y); y += 7; doc.setFontSize(11); splitText = doc.splitTextToSize((feedback.oportunidades || []).map(o => `- ${o.descripcion}`).join('\n') || "N/A", 180); doc.text(splitText, 14, y); y += splitText.length * 5 + 10; doc.setFontSize(14); doc.text("üéØ Siguiente Paso Sugerido", 14, y); y += 7; doc.setFontSize(11); splitText = doc.splitTextToSize(feedback.siguiente_paso_sugerido || "N/A", 180); doc.text(splitText, 14, y); y += splitText.length * 5 + 10; if (feedback.camino_a_la_excelencia) { doc.setFontSize(14); doc.text("üèÜ Camino a la Excelencia (C√≥mo alcanzar un 7.0)", 14, y); y += 7; doc.setFontSize(11); splitText = doc.splitTextToSize(feedback.camino_a_la_excelencia, 180); doc.text(splitText, 14, y); } }
    async function generarPortafolioEstudiante(studentName) { const studentEvals = appState.historial.filter(e => e.nombreEstudiante === studentName).sort((a,b) => new Date(a.configuracion.fecha) - new Date(b.configuracion.fecha)); if (studentEvals.length === 0) {alert("No se encontraron evaluaciones para este estudiante."); return;} const { jsPDF } = window.jspdf; const doc = new jsPDF(); const studentCourse = studentEvals[0].curso; doc.setFontSize(22); doc.text("Portafolio de Evidencias", 105, 80, { align: 'center' }); doc.setFontSize(16); doc.text(studentName, 105, 100, { align: 'center' }); doc.setFontSize(12); doc.text(studentCourse, 105, 110, { align: 'center' }); doc.setFontSize(10); doc.text(`Generado el: ${new Date().toLocaleDateString()}`, 105, 120, { align: 'center' }); doc.text("Este documento recopila el progreso y la retroalimentaci√≥n del estudiante.", 105, 150, { align: 'center' }); doc.addPage(); doc.setFontSize(18); doc.text("Resumen de Progreso", 14, 22); const tempCanvas = document.createElement('canvas'); tempCanvas.width = 800; tempCanvas.height = 400; renderStudentProgressChart(studentName, tempCanvas); const chartImage = tempCanvas.toDataURL('image/png'); doc.addImage(chartImage, 'PNG', 14, 30, 180, 90); const skillTableData = getStudentSkillsTableData(studentName); doc.autoTable({ startY: 130, head: [skillTableData.headers], body: skillTableData.rows, theme: 'grid', headStyles: { fillColor: [94, 114, 228] } }); studentEvals.forEach(evaluacion => { doc.addPage(); renderStudentPageForPDF(doc, evaluacion); }); doc.save(`Portafolio-${studentName}.pdf`);}
</script>
</body>
</html>
```