from fastapi import FastAPI, UploadFile, File, Form
from fastapi.responses import JSONResponse, FileResponse, HTMLResponse
from fastapi.staticfiles import StaticFiles
import os, httpx
from PIL import Image
import pytesseract

app = FastAPI()
app.mount("/static", StaticFiles(directory="static"), name="static")

@app.get("/", response_class=HTMLResponse)
async def root():
    return FileResponse("static/index.html")

async def extract_text_from_image(file: UploadFile) -> str:
    contents = await file.read()
    with open("temp_image.jpg", "wb") as f:
        f.write(contents)
    image = Image.open("temp_image.jpg")
    text = pytesseract.image_to_string(image)
    return text.strip()

@app.post("/evaluar")
async def evaluar(
    file: UploadFile = File(...),
    nombre: str = Form(...),
    curso: str = Form(...),
    asignatura: str = Form("")
):
    texto_extraido = await extract_text_from_image(file)

    prompt = f"""
Eres un evaluador profesional de alto nivel con experiencia en todas las asignaturas escolares y universitarias en Chile y Latinoamérica. Evalúa el contenido proporcionado como si fueras un profesor especialista en el área correspondiente.

Estudiante: {nombre}
Curso: {curso}
Asignatura: {asignatura if asignatura else 'Detectar automáticamente'}

Texto extraído de imagen:
{texto_extraido}

Requisitos:
- Detecta automáticamente el tipo de evaluación y asignatura si no se indica.
- Evalúa según estándares profesionales del área y nivel (incluyendo LGE Art. 67 si es Chile).
- Aplica criterios de corrección reales (profundidad, pertinencia, redacción, contenido visual, cálculos, etc.)
- Otorga una nota chilena de 1,0 a 7,0.
- Entrega un JSON con: asignatura detectada, tipo de evaluación, puntaje obtenido, nota, retroalimentación profesional extensa.

Formato de respuesta en JSON:
{{
  "asignatura": "...",
  "tipo": "...",
  "puntaje": "...",
  "nota": "...",
  "feedback": "..."
}}
"""

    headers = {
        "Authorization": f"Bearer {os.getenv('MISTRAL_API_KEY')}",
        "Content-Type": "application/json"
    }

    body = {
        "model": "mistral-large-latest",
        "messages": [
            {"role": "user", "content": prompt}
        ]
    }

    try:
        async with httpx.AsyncClient() as client:
            response = await client.post(
                "https://api.mistral.ai/v1/chat/completions",
                headers=headers,
                json=body
            )
            response.raise_for_status()
            content = response.json()["choices"][0]["message"]["content"]
            result = eval(content.strip())
    except Exception as e:
        result = {
            "asignatura": asignatura if asignatura else "Desconocida",
            "tipo": "Desconocido",
            "nota": "-",
            "puntaje": "-",
            "feedback": f"Error interno del servidor: {str(e)}"
        }

    return JSONResponse(content=result)